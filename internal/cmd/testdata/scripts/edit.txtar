mkhomedir
mksourcedir

# test that chezmoi edit edits a single file
exec chezmoi edit $HOME${/}.file
grep -count=1 '# edited' $CHEZMOISOURCEDIR/dot_file
! grep '# edited' $HOME/.file

# test that chezmoi edit --apply applies the edit.
exec chezmoi edit --apply --force $HOME${/}.file
grep -count=2 '# edited' $CHEZMOISOURCEDIR/dot_file
grep -count=2 '# edited' $HOME/.file

# test that chezmoi edit edits a symlink
exec chezmoi edit $HOME${/}.symlink
grep -count=1 '# edited' $CHEZMOISOURCEDIR/symlink_dot_symlink

# test that chezmoi edit edits a script
exec chezmoi edit $HOME${/}script.sh
grep -count=1 '# edited' $CHEZMOISOURCEDIR/run_script.sh

# test that chezmoi edit edits a file and a symlink
exec chezmoi edit $HOME${/}.file $HOME${/}.symlink
grep -count=3 '# edited' $CHEZMOISOURCEDIR/dot_file
grep -count=2 '# edited' $CHEZMOISOURCEDIR/symlink_dot_symlink

# test that chezmoi edit edits the working tree
exec chezmoi edit
exists $CHEZMOISOURCEDIR/.edited

# test that chezmoi edit edits a directory
[unix] exec chezmoi edit $HOME${/}.dir
[unix] exists $CHEZMOISOURCEDIR/dot_dir/.edited

chhome home2/user

# test that chezmoi edit edits a file when the working tree and the source dir are different
exec chezmoi edit $HOME${/}.file
grep -count=1 '# edited' $CHEZMOISOURCEDIR/home/dot_file

# test that chezmoi edit edits the working tree when working tree and the source dir are different
exec chezmoi edit
exists $CHEZMOISOURCEDIR/.edited
! exists $CHEZMOISOURCEDIR/home/.edited

-- home/user/.local/share/chezmoi/run_script.sh --
#!/bin/sh
-- home2/user/.config/chezmoi/chezmoi.toml --
sourceDir = "~/.local/share/chezmoi/home"
-- home2/user/.local/share/chezmoi/.git/.keep --
-- home2/user/.local/share/chezmoi/home/dot_file --
# contents of .file

# test that chezmoi apply backups changed files
exec chezmoi edit --backup $HOME/backup.tar $HOME${/}.file
exists $HOME/backup.tar
tarcontains $HOME/backup.tar .file
! tarcontains $HOME/backup.tar .empty
exists $HOME/.file
